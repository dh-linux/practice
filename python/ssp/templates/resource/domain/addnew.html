<!DOCTYPE html>
{%extends 'base.html'%}
{% block content_row %}

                                <div class="row">

                                    <div class="col-sm-7">
                                        <div class="space-6"></div>

                                        <div class="widget-box">
                                            <div class="widget-header widget-header-small">
                                                <h5 class="lighter">Domain Info Add.</h5>
                                            </div>

                                            <div class="widget-body">
                                                <div class="widget-main">
                                                    <form class="form-search" action="{{URL_ROOT}}/resource/domain/data/getinfo/" role="form" method="POST">{% csrf_token %}
                                                        <!-- <div>
                                                            <select name="type" class="form-control width-20" id="form-field-select-4">
                                                                <option value="domain">域名</option>
                                                                <option value="vip">VIP</option>
                                                            </select>
                                                        </div> -->
                                                        <div class="row">
                                                            <div class="col-xs-12 col-sm-8">
                                                                <div class="radio">
                                                                    <label>
                                                                        <input name="type" value="domain" checked type="radio" class="ace" />
                                                                        <span class="lbl">域名&nbsp;&nbsp;</span>
                                                                    </label>
                                                                    <label>
                                                                        <input name="type" value="vip" type="radio" class="ace" />
                                                                        <span class="lbl">VIP</span>
                                                                    </label>
                                                                </div>
                                                                <div class="input-group">
                                                                    <input name="dsrc" type="text" class="form-control search-query" placeholder="输入你需要添加或查询的域名或者VIP" />
                                                                    <span class="input-group-btn">
                                                                        <button type="button" class="btn btn-purple btn-sm J_get_domain_info">
                                                                            抓取
                                                                            <i class="icon-exchange icon-on-right bigger-110"></i>
                                                                        </button>
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                                <a href="#modal-table" id="zj-modal-table" role="button" class="green" data-toggle="modal"></a>
                                <div id="modal-table" class="modal fade" tabindex="-1">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <form class="form-search" action="{{URL_ROOT}}/resource/domain/data/add/" role="form" method="POST">{% csrf_token %}
                                            <div class="modal-header no-padding">
                                                <div class="table-header">
                                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                                        <span class="white">&times;</span>
                                                    </button>
                                                    <span class="white bigger modal-title">&times;</span>
                                                    <!-- <h5 class="blue bigger modal-title"></h5> -->
                                                </div>
                                            </div>

                                            <div class="modal-body no-padding">
                                                <table id="table_data_info" class="table table-striped table-bordered table-hover no-margin-bottom no-border-top">
                                                    <thead>
                                                    </thead>

                                                    <tbody>
                                                    </tbody>
                                                </table>
                                            </div>

                                            <div class="modal-footer no-margin-top">
                                            </div>
                                        </form>
                                        </div><!-- /.modal-content -->
                                    </div><!-- /.modal-dialog -->
                                </div><!-- PAGE CONTENT ENDS -->
{% endblock %}
{% block js %}
<script type="text/javascript">
$('#modal-form').on('shown.bs.modal', function () {
    $(this).find('.chosen-container').each(function(){
        $(this).find('a:first-child').css('width' , '510px');
        $(this).find('.chosen-drop').css('width' , '210px');
        $(this).find('.chosen-search input').css('width' , '200px');
    });
})

// 填充表格
function makeTable(data, type){
    if(!data) return;
    var t_title = tbody_html = thead_html = modal_footer = tr = '';
    if (type == 'domain') {
        thead_html = '\
                <tr>\
                    <th class="center">\
                        <label>\
                            <input type="checkbox" class="ace" />\
                            <span class="lbl"></span>\
                        </label>\
                    </th>\
                    <th class="center">dname</th>\
                    <th class="center">dynamic</th>\
                    <th class="center">attach</th>\
                    <th class="center">Type</th>\
                    <th class="center">Data</th>\
                    <th class="center">Gname</th>\
                    <th class="center">Enabled</th>\
                </tr>';

        for(var i =0;i<data.length;i++){
            tr = '<tr>' 
                     + '<td class="center"><label><input type="checkbox" name="dinfo" value="' + i + '" /><span class="lbl"></span></label></td>'
                     + '<td class="center j_dinfo"><input type ="hidden" disabled name="dname_' + i + '" value="' + data[i].dname + '">' + data[i].dname + '</td>'
                     + '<td class="center j_dinfo"><input type ="hidden" disabled name="dynamic_' + i + '" value="' + data[i].dynamic + '">' + data[i].dynamic + '</td>'
                     + '<td class="center j_dinfo"><input type ="hidden" disabled name="attach_' + i + '" value="' + data[i].attach + '">' + data[i].attach + '</td>'
                     + '<td class="center j_dinfo"><input type ="hidden" disabled name="type_' + i + '" value="' + data[i].type + '">' + data[i].type + '</td>'
                     + '<td class="center j_dinfo"><input type ="hidden" disabled name="data_' + i + '" value="' + data[i].data + '">' + data[i].data + '</td>'
                     + '<td class="center j_dinfo"><input type ="hidden" disabled name="gname_' + i + '" value="' + data[i].gname + '">' + data[i].gname + '</td>'
                     + '<td class="center j_dinfo"><input type ="hidden" disabled name="enabled_' + i + '" value="' + data[i].enabled + '">' + data[i].enabled + '</td>'
                     + '</tr>';
            tbody_html = tbody_html + tr;
        }
        modal_footer = '\
                    <button class="btn btn-sm" data-dismiss="modal">\
                        <i class="icon-remove"></i>\
                        Cancel\
                    </button>\
                    <button class="btn btn-sm btn-primary J_add_domain_info">\
                        <i class="icon-ok"></i>\
                        Save\
                    </button>\
                    <button name="force_add" value="1" class="btn btn-sm btn-primary J_add_domain_info">\
                        <i class="icon-ok"></i>\
                        Save+\
                    </button>\
        ';
        t_title = '域名访问分组信息';
    } else if (type == 'vip') {
        thead_html = '\
                <tr>\
                    <th class="center">Ip</th>\
                    <th class="center">Location</th>\
                    <th class="center">Type</th>\
                    <th class="center">Hostname</th>\
                    <th class="center">Virtualserver</th>\
                    <th class="center">Virtualaddress</th>\
                    <th class="center">Rule</th>\
                    <th class="center">Definition</th>\
                    <th class="center">Poolname</th>\
                    <th class="center">Poolmember</th>\
                    <th class="center">Poolstatus</th>\
                    <th class="center">VSstatus</th>\
                    <th class="center">Available</th>\
                </tr>';

        for(var i =0;i<data.length;i++){
            var poolmember_str = '';
            for (k in data[i].poolmember)
                poolmember_str = poolmember_str + data[i].poolmember[k] + '<br />';
            tr = '<tr>'
                     + '<td class="center">' + data[i].ip + '</td>'
                     + '<td class="center">' + data[i].location + '</td>'
                     + '<td class="center">' + data[i].type + '</td>'
                     + '<td class="center">' + data[i].hostname + '</td>'
                     + '<td class="center">' + data[i].virtualserver + '</td>'
                     + '<td>' + data[i].virtualaddress.replace(/,/g, '<br />') + '</td>'
                     + '<td class="center">' + data[i].rule + '</td>'
                     + '<td class="center">' + data[i].definition + '</td>'
                     + '<td class="center">' + data[i].poolname + '</td>'
                     + '<td>' + poolmember_str + '</td>'
                     + '<td class="center">' + data[i].poolstatus + '</td>'
                     + '<td class="center">' + data[i].virtualserverstatus + '</td>'
                     + '<td class="center">' + data[i].available + '</td>'
                     + '</tr>';
            tbody_html = tbody_html + tr;
        }
        t_title = 'VIP详情';
    }
    $(".modal-title").html(t_title);
    $("#table_data_info tbody").html(tbody_html);
    $("#table_data_info thead").html(thead_html);
    $(".modal-footer").html(modal_footer);
}

// $('table th input:checkbox').on('click' , function(){
$('table thead').on('click', 'input', function(){
    var that = this;
    $(this).closest('table').find('tr > td:first-child input:checkbox')
    .each(function(){
        this.checked = that.checked;
        $(this).closest('tr').find('input[type="hidden"]').attr("disabled", !this.checked);
        $(this).closest('tr').toggleClass('selected');
    });
        
});

$('#table_data_info tbody').on('click', 'input', function(){
    $(this).closest('tr').find('input[type="hidden"]').attr("disabled", !this.checked);
});

$('.J_get_domain_info').on("click",function(){
    var $form = $(this).parents("form");
    $form.ajaxSubmit({
        dataType:'json',
        success:function(r){
            try{
                if(r.data){
                    makeTable(r.data, r.type);
                    // $('#aaa').trigger('click');
                    $('#zj-modal-table').trigger('click');
                }else if(!data.msg){
                    alert("网络异常！");
                }else{
                    alert(data.msg);
                }
            }catch(err){
                console.log(err);
            }
        }
    });
});

// $(".J_add_domain_info").on("click",function(e){
$('.modal-footer').on("click", '.J_add_domain_info', function(e){
    e.preventDefault();
    var $form = $(this).parents("form");
    $form.ajaxSubmit({
        data:{force_add:this.name=="force_add"?1:0},
        dataType:'json',
        success:function(r){
            try{
                if(r){
                    $('.close').trigger('click');
                    tips('操作成功!');
                }else if(!r.msg){
                    tips('网络异常!');
                }else{
                    tips(r.msg);
                }
            }catch(err){
                console.log(err);
            }
        }
    });
});
</script>
{% endblock %}